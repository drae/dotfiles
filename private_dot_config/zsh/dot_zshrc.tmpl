#!/usr/bin/env zsh
# vim: ft=zsh ts=2 sw=2

setopt extended_history
setopt hist_expire_dups_first
setopt hist_ignore_dups
setopt hist_ignore_space
setopt hist_verify
setopt inc_append_history
setopt share_history
setopt combining_chars

# Support Windows Terminal duplication 
{{ if (eq .chezmoi.os "linux") }}
  {{ if (.chezmoi.kernel.osrelease | lower | contains "microsoft") }}
    set_wt_cwd() { printf "\e]9;9;%s\e\\" "$(wslpath -m "$PWD")" }
    precmd_functions+=set_wt_cwd
  {{ end }}
{{ end }}

#
# zinit
#
declare -A ZINIT
ZINIT[HOME_DIR]="${XDG_DATA_HOME}/zinit"
ZINIT[ZCOMPDUMP_PATH]="${XDG_CACHE_HOME}/zsh/zcompdump-${ZSH_VERSION}"
ZINIT[COMPINIT_OPTS]='-C'

if [[ ! -f ${ZINIT[HOME_DIR]}/bin/zinit.zsh ]]; then
    print -P "%F{33}▓▒░ %F{220}Installing %F{33}DHARMA%F{220} Initiative Plugin Manager (%F{33}zdharma/zinit%F{220})…%f"
    command mkdir -p "${XDG_DATA_HOME}/zinit" && command chmod g-rwX "${XDG_DATA_HOME}/zinit"
    command git clone https://github.com/zdharma/zinit "${XDG_DATA_HOME}/zinit/bin" && \
        print -P "%F{33}▓▒░ %F{34}Installation successful.%f%b" || \
        print -P "%F{160}▓▒░ The clone has failed.%f%b"
fi

source "${ZINIT[HOME_DIR]}/bin/zinit.zsh"
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

# Install some zinit helpers
zinit wait lucid light-mode for \
  zinit-zsh/z-a-rust \
  zinit-zsh/z-a-as-monitor \
  zinit-zsh/z-a-bin-gem-node

zinit lucid for \
  'OMZ::lib/history.zsh' \
  'OMZ::lib/key-bindings.zsh' \
  'OMZ::lib/completion.zsh' \
  'OMZ::plugins/kubectl/kubectl.plugin.zsh' 

zinit wait lucid for \
  atload'_zsh_autosuggest_start' zsh-users/zsh-autosuggestions \
  zsh-users/zsh-history-substring-search \
  zdharma/history-search-multi-word \
  atinit'zpcompinit; zpcdreplay' zdharma/fast-syntax-highlighting \
  MichaelAquilina/zsh-history-filter

# Load starship theme
zinit ice as"command" from"gh-r" atclone"./starship init zsh > init.zsh; ./starship completions zsh > _starship" atpull"%atclone" src"init.zsh"
zinit light starship/starship

# Little notification of aliases
zinit light djui/alias-tips

# Window title support
zinit light mdarocha/zsh-windows-title

zinit ice atclone"dircolors -b LS_COLORS > clrs.zsh" \
    atpull'%atclone' pick"clrs.zsh" nocompile'!' \
    atload'zstyle ":completion:*" list-colors ${(s.:.)LS_COLORS}'
zinit light trapd00r/LS_COLORS

#
# Local app installation
#

# krew - kubectl plugin manager
zinit from'gh-r' as'program' mv'krew* -> krew' \
  atclone'./krew install krew' atpull'%atclone' \
  pick'krew' for \
    kubernetes-sigs/krew

# fluxctl
zinit from'gh-r' as'program' \
  atclone'./flux completion zsh > _flux' atpull'%atclone' \
  pick'flux' src="_flux" for \
    fluxcd/flux2

# g - Go version manager
zinit as'program' mv'*/g -> g' \
  atclone'./g install latest' atpull'%atclone' \
  pick'g' for \
    stefanmaric/g

# FZF
zinit ice lucid wait'0b' from'gh-r' as'program'
zinit light junegunn/fzf
zinit ice lucid wait'0c' as'command' pick'bin/fzf-tmux'
zinit light junegunn/fzf
zinit ice lucid wait'0c' multisrc'shell/{completion,key-bindings}.zsh' id-as'junegunn/fzf_completions' pick'/dev/null'
zinit light junegunn/fzf

# FZF-TAB
zinit ice wait'1' lucid
zinit light Aloxaf/fzf-tab

# direnv
zinit from"gh-r" as"program" mv"direnv* -> direnv" \
  atclone'./direnv hook zsh > zhook.zsh' atpull'%atclone' \
  pick"direnv" src="zhook.zsh" for \
    direnv/direnv

# Sharkdp's find and cat replacements
zinit ice as'program' id-as'fd' from'gh-r' mv'fd* -> fd' cp'fd/autocomplete/_fd -> _fd' pick'fd/fd'
zinit light sharkdp/fd
zinit ice as'program' id-as'bat' from'gh-r' mv'bat* -> bat' cp'bat/autocomplete/bat.zsh -> _bat' pick'bat/bat' atload'alias cat=bat'
zinit light sharkdp/bat

# ripgrep
zinit ice from'gh-r' as'program' id-as'rg' mv'ripgrep* -> rg' cp'rg/complete/_rg -> _rg' pick'rg/rg'
zinit light BurntSushi/ripgrep

# exa
zinit ice wait'2' lucid id-as'exa' from'gh-r' as'program' mv'bin/exa* -> exa' cp'completions/exa.zsh -> _exa'
zinit light ogham/exa
zinit ice wait blockf atpull'zinit creinstall -q .'

# yq
zinit ice lucid wait'0' as'program' id-as'yq' from'gh-r' mv'yq_* -> yq' \
 atclone'yq shell-completion zsh > _yq' atpull'%atclone'
zinit light mikefarah/yq

# github cli
zinit ice lucid as'command' from'gh-r' atclone'./gh completion -s zsh > _gh' atpull'%atclone' mv'**/bin/gh* -> gh' pick'usr/bin/gh'
zinit light cli/cli

# k9s
zinit ice lucid as'command' from'gh-r' pick 'k9s'
zinit light derailed/k9s

# git extras 
zinit lucid wait'0a' for \
  as"program" pick"$ZPFX/bin/git-*" src"etc/git-extras-completion.zsh" make"PREFIX=$ZPFX" tj/git-extras

# delta - git pager
zinit from"gh-r" as"command" mv"delta* -> delta" \
  pick"delta/delta" for \
    dandavison/delta

# procs (modern replacement for ps written in rust)
zinit wait'1' lucid \
  from'gh-r' as'program' \
  atload'alias ps=procs' \
  mv'**/procs -> procs' \
  pick'procs' \
  light-mode for \
    @dalance/procs

# cheat.sh
zinit wait'2a' lucid \
  id-as'cht.sh' \
  as'program' for \
    https://cht.sh/:cht.sh
zinit wait'2b' lucid \
  id-as'cht-completion' \
  has'rlwrap' \
  mv'cht* -> _cht' \
  as'completion' for \
    https://cheat.sh/:zsh

# cheat
zinit wait'2a' lucid \
  id-as'cheat' \
  from'gh-r' \
  mv'cheat* -> cheat' \
  pick'cheat' \
  as'program' \
  for @cheat/cheat
zinit wait'2b' lucid \
  id-as'cheat-completion' \
  mv'cheat* -> _cheat' \
  as'completion' \
  for https://github.com/cheat/cheat/blob/master/scripts/cheat.zsh

# Start ssh-agent with shell
zinit light bobsoppe/zsh-ssh-agent

#
# FZF options
#

# Use fd instead of find for file completion
_fzf_compgen_path() {
    fd --hidden --follow --exclude ".git" . "$1"
}

# Use fd to generate the list for directory completion
_fzf_compgen_dir() {
    fd --type d --hidden --follow --exclude ".git" . "$1"
}

export FZF_DEFAULT_COMMAND='rg --files --no-ignore --hidden --follow -g "!{.git,node_modules}/*" 2>/dev/null'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_CTRL_T_OPTS='--preview="bat --color=always --style=header {} 2>/dev/null" --preview-window=right:60%:wrap'
export FZF_ALT_C_COMMAND='fd -t d -d 1'
export FZF_ALT_C_OPTS='--preview="exa -1 --icons --git --git-ignore {}" --preview-window=right:60%:wrap'

export ZSH_AUTOSUGGEST_STRATEGY=(history completion)
export ZSH_AUTOSUGGEST_USE_ASYNC=1
export ZSH_AUTOSUGGEST_MANUAL_REBIND=1

# Other sources
source $ZDOTDIR/aliases.zsh
source $ZDOTDIR/bindings.zsh

